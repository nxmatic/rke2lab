# Remove all devices with names starting with 'bioskop-'

HOSTNAME=${1:-${LIMA_HOSTNAME}}

curl -s -H "Authorization: Bearer $TSKEY_API_TOKEN" "https://api.tailscale.com/api/v2/tailnet/-/devices" |
  env HOSTNAME=$HOSTNAME yq -p json -r '.devices[] | select(.hostname | test("^" + strenv(HOSTNAME)+ "-")) | .id' |
  while read ID; do
    : "Removing device $ID"
    curl -X DELETE -H "Authorization: Bearer $TSKEY_API_TOKEN" \
      "https://api.tailscale.com/api/v2/device/$ID"
  done