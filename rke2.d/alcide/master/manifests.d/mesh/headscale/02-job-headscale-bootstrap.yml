---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    internal.kpt.dev/upstream-identifier: batch|Job|${headscale-namespace}|headscale-bootstrap
    kpt.dev/package-layer: mesh
    kpt.dev/package-name: headscale
  name: headscale-bootstrap
  namespace: headscale-system
spec:
  template:
    metadata:
      annotations:
        kpt.dev/package-layer: mesh
        kpt.dev/package-name: headscale
    spec:
      containers:
        - command:
            - sh
            - -c
            - |
              set -ex

              # Install dependencies
              apk add --no-cache curl kubectl jq

              echo "Waiting for Headscale server to be ready..."
              until curl -sf http://headscale:8080/health; do
                echo "Headscale not ready, retrying in 5s..."
                sleep 5
              done

              echo "Waiting for headscale pod to be running..."
              until kubectl get pod -n "$HEADSCALE_NAMESPACE" -l app=headscale -o jsonpath='{.items[0].status.phase}' 2>/dev/null | grep -q Running; do
                echo "Headscale pod not ready, retrying in 2s..."
                sleep 2
              done

              # Use kubectl exec to run headscale CLI inside the pod
              # The CLI has direct access to headscale without API key requirements

              echo "Creating admin user..."
              kubectl exec -n "$HEADSCALE_NAMESPACE" deployment/headscale -- \
                headscale users create admin 2>/dev/null || echo "User admin already exists"

              echo "Getting admin user ID..."
              USER_JSON=$$(kubectl exec -n "$HEADSCALE_NAMESPACE" deployment/headscale -- \
                headscale users list -o json)
              USER_ID=$$(echo "$$USER_JSON" | jq -r '.[] | select(.name=="admin") | .id // empty')

              if [ -z "$$USER_ID" ]; then
                echo "ERROR: Failed to get admin user ID"
                echo "User list output: $$USER_JSON"
                exit 1
              fi

              echo "Admin user ID: $$USER_ID"

              echo "Creating reusable preauth key..."
              PREAUTH_JSON=$$(kubectl exec -n "$HEADSCALE_NAMESPACE" deployment/headscale -- \
                headscale preauthkeys --user "$$USER_ID" create \
                --reusable --expiration 720h -o json)

              PREAUTH_KEY=$$(echo "$$PREAUTH_JSON" | jq -r '.key // empty')

              if [ -z "$$PREAUTH_KEY" ]; then
                echo "ERROR: Failed to extract preauth key"
                echo "Preauth key output: $$PREAUTH_JSON"
                exit 1
              fi

              echo "Preauth key created: $${PREAUTH_KEY:0:16}..."

              echo "Storing preauth key in Secret..."
              kubectl create secret generic headscale-client-auth \
                --from-literal=authkey="$$PREAUTH_KEY" \
                --dry-run=client -o yaml | kubectl apply -f -

              echo "Bootstrap complete!"
          env:
            - name: HEADSCALE_NAMESPACE
              value: headscale-system
          image: alpine:3.19
          name: bootstrap
      restartPolicy: OnFailure
      serviceAccountName: headscale-bootstrap
  ttlSecondsAfterFinished: 300
